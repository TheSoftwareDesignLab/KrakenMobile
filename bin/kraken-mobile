#!/usr/bin/env ruby

require File.join(File.dirname(__FILE__), 'kraken_mobile_helpers')
require File.join(File.dirname(__FILE__), 'kraken_mobile_setup')
require File.join(File.dirname(__FILE__), 'kraken_mobile_calabash_android')
$LOAD_PATH << File.expand_path('../lib', __dir__)
require 'kraken_mobile'
require 'kraken-mobile/constants'

#-------------------------------
# AGV reader helper
#-------------------------------

def read_configuration
  configuration_command = ARGV.select do |arg|
    arg.include?('--configuration=')
  end.first
  return if configuration_command.nil?

  configuration_command = configuration_command.strip.downcase
  configuration_command.slice!('--configuration=')
  configuration_command
end

def read_properties
  properties_command = ARGV.select { |arg| arg.include?('--properties=') }.first
  return if properties_command.nil?

  properties_command = properties_command.strip.downcase
  properties_command.slice!('--properties=')
  properties_command
end

#-------------------------------
# Command reader
#-------------------------------

if ARGV.length.zero?
  print_usage
else
  cmd = ARGV.shift
  case cmd
  when 'version'
    require 'kraken-mobile/version'
    puts KrakenMobile::VERSION
  when 'devices'
    require 'kraken-mobile/helpers/devices_helper/manager'
    print_devices
  when 'setup'
    KrakenSetup.new.run
  when 'gen'
    scaffold_folder_structure
  when 'resign'
    require 'calabash-android/helpers'
    ensure_apk_is_specified
    puts 'Resigning APK with Calabash-Android'
    resign_apk(File.expand_path(ARGV.first))
  when 'run'
    require File.join(File.dirname(__FILE__), 'kraken_mobile_calabash_android')
    configuration = read_configuration
    properties = read_properties
    handle_calabash_android(configuration, properties)
  else
    print_usage
  end
end
